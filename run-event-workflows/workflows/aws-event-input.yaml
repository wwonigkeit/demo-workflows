direktiv_api: workflow/v1

description: Execute an AWS CLI commmand based on an event coming in from AWS EventBridge

#
# The start definition which starts the worklfow based on the event received from the
# vault workflow. Example of the event is shown above in the description
#
# start:
#   type: event
#   state: check-event
#   event: 
#     type: "AWS API Call via CloudTrail"

functions:
  # This is a simple aws-cli container from hub.docker.com
  - id: aws-cli
    image: amazon/aws-cli
    type: knative-workflow
    size: small
    cmd: /usr/share/direktiv/direktiv-cmd
 
states:
  # Let's get all the instances for the region in which we're working
  - id: get-ec2-instance
    type: action
    action:
      secrets: ["AWS_ACCESS_KEY_ID","AWS_SECRET_ACCESS_KEY"]
      function: aws-cli
      input:
        data:
          commands:
          - command: aws configure set aws_access_key_id jq(.secrets.AWS_ACCESS_KEY_ID)
            suppress_command: true
          - command: aws configure set aws_secret_access_key jq(.secrets.AWS_SECRET_ACCESS_KEY)
            suppress_command: true
          - command: aws configure set region ap-southeast-2
            suppress_command: true
          - command: aws ec2 describe-instances
    transform: 'jq( { instances: ( ( .return[3].Output | fromjson ) | .Reservations ) } )'          